# Integer bitCount

```java
public static int bitCount(int i) {
    // HD, Figure 5-2
    i = i - ((i >>> 1) & 0x55555555);
    i = (i & 0x33333333) + ((i >>> 2) & 0x33333333);
    i = (i + (i >>> 4)) & 0x0f0f0f0f;
    i = i + (i >>> 8);
    i = i + (i >>> 16);
    return i & 0x3f;
}
```

## 建立数学符号和目标
$$
i=b_{31}·2^{31}+b_{30}·2^{30}+...+b_1·2^1+b_0·2^0
$$
目标是求值：$$b_0+b_1+...+b_{30}+b_{31}$$

## 第一步

```java
i = i - ((i >>> 1) & 0x55555555);
```
$$
i>>>1=0+b_{31}·2^{30}+b_{30}·2^{29}+...+b_2·2^{1}+b_1·2^0
$$

$$
0x55555555 = 0101\ 0101\  0101\  0101\ 0101\ 0101\ 0101\ 0101
$$

$$
(i>>>1) \& 0x55555555
= b_{31}·2^{30}+b_{29}·2^{28}+...+b_{3}·2^{2}+b_{1}·2^{0}
$$

---

$$
i- ((i>>>1) \& 0x55555555)=\\
b_{31}·2^{31}+b_{30}·2^{30}+...+b_1·2^1+b_0·2^0 \\
-
b_{31}·2^{30}+b_{29}·2^{28}+...+b_{3}·2^{2}+b_{1}·2^{0}\\

=(b_{30}-b_{31})·2^{30}+b_{31}·2^{31}+...+(b_2-b_3)·2^2+b_3·2^3+(b_0-b_1)·2^0+b_1·2^1 \\

=(b_{30}+b_{31})·2^{30}+...+(b_2+b_3)·2^2+(b_0+b_1)·2^0\\
$$

赋值后，此时
$$
i = (b_{30}+b_{31})·2^{30}+(b_{28}+b_{29})·2^{28}...+(b_2+b_3)·2^2+(b_0+b_1)·2^0
$$

两个一组。

## 第二步

```java
i = (i & 0x33333333) + ((i >>> 2) & 0x33333333);
```

$$
(i >>> 2)=(b_{30}+b_{31})·2^{28}+(b_{28}+b_{29})·2^{26}...+(b_2+b_3)·2^0
$$

$$
0x33333333= 0011\ 0011\ 0011\ 0011\ 0011\ 0011\ 0011\ 0011\
$$

---

$$
((i >>> 2) \& 0x33333333)=\\
(b_{30}+b_{31})·2^{28}+(b_{26}+b_{27})·2^{24}...+(b_6+b_7)·2^4+(b_2+b_3)·2^0
$$
---


$$
(i \& 0x33333333)=\\
(b_{28}+b_{29})·2^{28}+(b_{24}+b_{25})·2^{24}+...+(b_4+b_5)·2^4+(b_0+b_1)·2^0
$$

---

$$
(i \& 0x33333333) + ((i >>> 2) \& 0x33333333)=\\
(b_{28}+b_{29}+b_{30}+b_{31})2^{28}+
(b_{24}+b_{25}+b_{26}+b_{27})2^{24}+...+\\
(b_{4}+b_{5}+b_{6}+b_{7})2^{4}+
(b_{0}+b_{1}+b_{2}+b_{3})2^{0}
$$

四个一组。



### 第三步

```java
i = (i + (i >>> 4)) & 0x0f0f0f0f;
```

$$
i=(b_0+b_1+b_2+...+b_6+b_7)\cdot2^0+\\(b_8+b_9+b_{10}+b_{11}+...+b_{14}+b_{15})\cdot2^8+...+\\(b_{24}+b_{25}+b_{26}+...+b_{30}+b_{31})\cdot2^{24}
$$

八个一组。



### 第四步

```java
i = i + (i >>> 8);
```

$$
i=(b_0+b_1+b_2+...+b_{14}+b_{15})\cdot2^0+(b_8+b_9+b_{10}+...+b_{22}+b_{23})\cdot2^8\\
+(b_{16}+b_{17}+b_{18}+...+b_{30}+b_{31})\cdot2^{16}+(b_{24}+b_{25}+b_{26}+...+b_{30}+b_{31})\cdot2^{24}
$$



## 第五步

```java
i = i + (i >>> 16);
```

$$
i=(b_0+b_1+b_2+...+b_{30}+b_{31})\cdot2^0+(b_8+b_9+b_{10}+...+b_{30}+b_{31})\cdot2^8\\
+(b_{16}+b_{17}+b_{18}+...+b_{30}+b_{31})\cdot2^{16}+(b_{24}+b_{25}+b_{26}+...+b_{30}+b_{31})\cdot2^{24}
$$



目标就是取$(b_0+b_1+b_2+...+b_{30}+b_{31})\cdot2^0$的系数。

## 第六步

```java
i & 0x3f;
```

`0x3f`为11 1111，结果可以分离出 $ (b_0+b_1+b_2+...+b_{30}+b_{31})$

